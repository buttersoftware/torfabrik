{% extends 'pspiessLetsplayBundle::layout.html.twig' %}

{% block title %}Reservierungen{% endblock %}

{% block stylesheets %}
    {{ parent()}}

    <!-- page specific plugin styles -->
    <link href="{{ asset('resources/css/jquery-ui.min.css')}}" rel="stylesheet">
    <link href="{{ asset('resources/css/jquery-ui.custom.min.css')}}" rel="stylesheet">
    <link href="{{ asset('resources/css/fullcalendar.css')}}" rel="stylesheet">
    <link href="{{ asset('resources/css/datepicker.css')}}" rel="stylesheet">
{% endblock %}

{% block nav %}
    {{ knp_menu_render('pspiessLetsplayBundle:MenuBuilder:mainMenu', {'currentClass': 'active', 'template': 'pspiessLetsplayBundle:Menu:knp_menu.html.twig'}) }}
{% endblock %}

{% block body -%}

    <!-- /section:settings.box -->
    <div class="page-content-area">
        <div class="page-header">
            <h1>
                Reservierungsübersicht
                <small>
                    <i class="ace-icon fa fa-angle-double-right"></i>
                    alle Reservierungen
                </small>
            </h1>
            
        </div><!-- /.page-header -->
        <div class="col-lg-12">
            <div class="col-lg-3">
                <span class="label label-lg label-info">reserviert</span>
                <span class="label label-lg label-danger">nicht bezahlt</span>
                <span class="label label-lg label-success">bezahlt</span>
                <span class="label label-lg label-warning">storniert</span>
            </div>
        </div>
        <div class="col-lg-12"></div>
        <div class="col-xs-12">
            <!-- PAGE CONTENT BEGINS -->
            <div class="col-lg-3">
                <span class="label label-lg label-info arrowed-right">Platz 1</span>
                <span class="label label-lg label-yellow arrowed-in">4er Court</span>
                <div class="space"></div>
                <div id="calendar1" style="height: 500px"></div>
                <!-- #section:plugins/data-time.calendar -->
                <div></div>
                <!-- /section:plugins/data-time.calendar -->
            </div>
            <div class="col-sm-3">
                <span class="label label-lg label-info arrowed-right">Platz 2 - 4er Court</span>
                <span class="label label-lg label-yellow arrowed-in">4er Court</span>
                <div class="space"></div>
                <!-- #section:plugins/data-time.calendar -->
                <div id="calendar2"></div>

                <!-- /section:plugins/data-time.calendar -->
            </div>
            <div class="col-sm-3">
                <span class="label label-lg label-info arrowed-right">Platz 3 - 5er Court</span>
                <span class="label label-lg label-yellow arrowed-in">5er Court</span>
                <div class="space"></div>
                <!-- #section:plugins/data-time.calendar -->
                <div id="calendar3"></div>

                <!-- /section:plugins/data-time.calendar -->
            </div>
            <div class="col-sm-3">
                <span class="label label-lg label-info arrowed-right">Platz 4 - 5er Court</span>
                <span class="label label-lg label-yellow arrowed-in">5er Court</span>
                <div class="space"></div>
                <!-- #section:plugins/data-time.calendar -->
                <div id="calendar4"></div>

                <!-- /section:plugins/data-time.calendar -->
            </div>
            <!-- PAGE CONTENT ENDS -->
        </div><!-- /.col -->
    </div><!-- /.page-content-area -->
    
    {#<div class="popup"><h3>Neu Reservierung hinzufügen</h3>
        <h3 class="header blue lighter smaller">Kunde :</h3>
        <div class="row">
            <form>
                <div class="col-sm-6 col-md-8">
                    <input id="customer" class="title input-xxlarge" type="text" class="form-control"/>
                    <input type="hidden" name="customer_id" id="customer_id" />
                    <select name=mytextarea>
                        <option name=one value=one> einmalig </option>
                        <option name=two value=two> jede Woche </option>
                        <option name=three value=three> jede 2te Woche </option>
                        <option name=three value=three> jeden Monat </option>
                    </select>
                    <div class="space-4"></div>
                    <a href="#" class="submitForm btn btn-success">reservieren</a>
                    <a href="{{ path('pspiess_letsplay_customer_new') }}" class="submitForm btn btn-info">neuer Kunde</a>
                </div>
            </form>
        </div>
    </div>#}
    <div id="dialog-message" class="hide">
        <form>
            <div class="col-md-12">
                <div class="form-group">
                    <label for="customer">Kunde</label>
                    <input id="customer" class="title input-xxlarge" type="text" class="form-control"/>
                    <input type="hidden" name="customer_id" id="customer_id" />
                </div>
            </div>
            <div class="col-md-8">
                <select id="serial" name="serial">
                    <option name="day" value="0"> einmalig </option>
                    <option name="week" value="1"> jede Woche </option>
                    <option name="2week" value="2"> jede 2te Woche </option>
                    <option name="month" value="3"> jeden Monat </option>
                </select>
            </div>
            <div class="col-md-4">                    
                <div class="input-group">
                    <input class="form-control date-picker" id="serial_date" type="text" data-date-format="dd.mm.yyyy" />
                    <span class="input-group-addon">
                        <i class="fa fa-calendar bigger-110"></i>
                    </span>
                </div>
            </div>
        </form>
    </div><!-- #dialog-message -->
    {#
                <div class="space-4"></div>
                <a href="#" class="submitForm btn btn-success">reservieren</a>
                <a href="{{ path('pspiess_letsplay_customer_new') }}" class="submitForm btn btn-info">neuer Kunde</a>#}

    {#<a href="#" id="id-btn-dialog1" class="btn btn-purple btn-sm">Modal Dialog</a>#}
{% endblock %}

{% block javascripts %}
    {{ parent()}}
    <script src="{{ asset('resources/js/ace-extra.min.js')}}" type="text/javascript"></script>
    <script src="{{ asset('resources/js/jquery-ui.min.js')}}" type="text/javascript"></script>
    <script src="{{ asset('resources/js/jquery-ui.custom.min.js')}}" type="text/javascript"></script>
    <script src="{{ asset('resources/js/jquery.ui.touch-punch.min.js')}}" type="text/javascript"></script>
    <script src="{{ asset('resources/js/date-time/moment.min.js')}}" type="text/javascript"></script>
    <script src="{{ asset('resources/js/date-time/bootstrap-datepicker.min.js')}}" type="text/javascript"></script>
    <script src="{{ asset('resources/js/fullcalendar/fullcalendar.min.js')}}" type="text/javascript"></script>
    <script src="{{ asset('resources/js/fullcalendar/lang/de.js')}}" type="text/javascript"></script>
    <script src="{{ asset('resources/js/bootbox.min.js')}}" type="text/javascript"></script>
    {#<script src="{{ asset('resources/js/date-time/locales/bootstrap-datepicker.de.js')}}" type="text/javascript"></script>#}
    {#<div class="spinner" ng-show="loading"></div>#}
<script type="text/javascript">
    function CalendarResponse(start, end, fieldid) {
        var title = $(".title").val(); // gets title value
        var customerid = $('#customer_id').val();
        var serial = $('#serial').val();
        var serial_date = $('#serial_date').val();
        if (title !== "") { // if the title exists run script
            $.ajax({
                url: '{{ path('pspiess_letsplay_booking_add') }}',
                data: {"title": title, "start": start, "end": end, "customerid": customerid, "fieldid": fieldid, "serial": serial, "serial_date":serial_date},
                type: 'post',
                success: function(result) {
                    console.log(result);
                    $('#calendar1').fullCalendar('renderEvent', {
                        id:result,
                        title: title,
                        start: start,
                        end: end, //alle werte die neu dazugekommen sind auch id !!!
                    }, true);
                    $(".title").val(""); // clear title field
                },
                error: function(jqXHR, exception) {
                },
            })
        }
    }
    function showDialog (start, end, fieldid) {
        var dialog = $("#dialog-message").removeClass('hide').dialog({
            modal: true,
            title: "Reservierung hinzufügen",
            title_html: true,
            width: 500,
            buttons: [
            { text: "neuer Kunde",
                "class": "btn btn-primary btn-xs",
                click: function() {
                    window.location.href = Routing.generate('pspiess_letsplay_customer_new'),
                    $(this).dialog("close");
                }
            },
            { text: "reservieren",
                "class": "btn btn-success btn-xs",
                "id": "add_reservation",
                click: function() {
                    CalendarResponse(start, end, fieldid),
                    $(this).dialog("close");
                }
            }
            ]
        });
        $("#add_reservation").attr("disabled", "disabled");
    }
    function showChangeDialog (start, end, fieldid, calendar, id) {
        var dialog = $("#dialog-message").removeClass('hide').dialog({
            modal: true,
            title: "Reservierung bearbeiten",
            title_html: true,
            width: 500,
            buttons: [
            { text: "ändern",
                "class": "btn btn-success btn-xs",
                "id": "add_reservation",
                click: function() {
                    UpdateCalendar(start, end, fieldid, calendar, id),
                    $(this).dialog("close");
                }
            },
            { text: "abrechnen",
                "class": "btn btn-primary btn-xs",
                click: function() {
                    window.location.href = Routing.generate('pspiess_letsplay_invoice_new', {id:id})
                }
            },
            { text: "stornieren",
                "class": "btn btn-warning btn-xs",
                click: function() {
                    CancelCalendar(id),
                    $(this).dialog("close");
                }
            },
            { text: "löschen",
                "class": "btn btn-danger btn-xs",
                click: function() {
                    DeleteReservation(id, calendar, start, end),
                    $(this).dialog("close");
                }
            }
            ]
        });
        $("#add_reservation").attr("disabled", "disabled");
    }
    
    function UpdateCalendar(start, end, fieldid, calendar, id) {
        var title = $(".title").val(); // gets title value
        var customerid = $('#customer_id').val();
        $.ajax({
            url: '{{ path('pspiess_letsplay_booking_update') }}',
            data: {"start": start, "end": end, "id":id, "customerid": customerid, "title":title},
            type: "POST",
            success: function(json) {
            }
        });
    }
    function DeleteReservation (id, calendar, start, end) {
        $.ajax({
            url: '{{ path('pspiess_letsplay_booking_delete') }}',
            data: {"id":id},
            type: "POST",
            success: function(json) {
                calendar.fullCalendar('removeEvents', id);
                calendar.fullCalendar("rerenderEvents");
            }
        });
    }
    function CancelCalendar(id) {
        $.ajax({
            url: '{{ path('pspiess_letsplay_booking_cancel') }}',
            data: {"id":id},
            type: "POST",
            success: function(json) {
                
            }
        });
    }
    
    jQuery(function($) {
        //DateTime
        $('.date-picker').datepicker({
            autoclose: true,
            todayHighlight: true,
            format: 'dd.mm.yyyy',
            
        })
        //show datepicker when clicking on the icon
        .next().on(ace.click_event, function () {
            $(this).prev().focus();
        });
        $('body').on('click', 'button.fc-prev-button', function() {
            });
        $('.fc-button-next span').click(function(){
            alert('nextis clicked, do something');
        });
        $(document).ajaxStart(function() {
            $('#loading').html('<img src="loading.gif"> loading...');
        });
        $(document).ajaxStop(function() {
            $('#loading').html('<img src="loading.gif"> loading...');
        });
        
        //autocomplete
        var raw = {{ render(controller('pspiessLetsplayBundle:Customer:getAllCustomer')) }};
        var source = [ ];
        var mapping = { };
        for (var i = 0; i < raw.length; ++i) {
            source.push(raw[i].label);
            mapping[raw[i].label] = raw[i].value;
        }
        $("#customer").autocomplete({
            appendTo: "#dialog-message", //problems with z-index
            source: source,
            select: function(event, ui) {
                $('#customer_id').val(mapping[ui.item.value]);
                $("#add_reservation").removeAttr("disabled");
            },
            change: function(event, ui) {
                if (!ui.item) {
                    $("#add_reservation").attr("disabled", "disabled");
                    $(this).val(''); 
                } else {
                    $("#add_reservation").removeAttr("disabled");  
                }
            }
        });

        /* initialize the calendar */
        var date = new Date();
        var d = date.getDate();
        var m = date.getMonth();
        var y = date.getFullYear();
        var calendar = $('#calendar1').fullCalendar({
            defaultView: 'agendaDay',
            lang: 'de',
            minTime: "10:00:00",
            //isRTL: true,
            allDaySlot: false,
            height: 650,
            buttonHtml: {
                prev: '<i class="ace-icon fa fa-chevron-left"></i>',
                next: '<i class="ace-icon fa fa-chevron-right"></i>'
            },
            header: {
                left: 'title',
                center: '',
                right: 'today prev,next'
            },
            events:{{ render(controller('pspiessLetsplayBundle:Booking:showCalendar', {'iField': '28'})) }},
            editable: true,
            droppable: true, // this allows things to be dropped onto the calendar !!!
            selectable: true,
            selectHelper: true,
            select: function(start, end) {
{#                alert('select');#}
                showDialog(start.format("YYYY-MM-DD HH:mm:ss"), end.format("YYYY-MM-DD HH:mm:ss"), 28);
            },
            editable: true,
            eventDrop: function(event, delta) {
                $.ajax({
                    url: '{{ path('pspiess_letsplay_booking_update') }}',
                    data: {"start": event.start.format("YYYY-MM-DD HH:mm:ss"), "end": event.end.format("YYYY-MM-DD HH:mm:ss"), "id":event.id},
                    type: "POST",
                    success: function(json) {
{#                        alert('drop');#}
                    }
                });
            },
            eventResize: function(event) {
                $.ajax({
                    url: '{{ path('pspiess_letsplay_booking_update') }}',
                    data: {"start": event.start.format("YYYY-MM-DD HH:mm:ss"), "end": event.end.format("YYYY-MM-DD HH:mm:ss"), "id":event.id},
                    type: "POST",
                    success: function(json) {
{#                        alert('resize');#}
                    }
                });
            },
            eventClick: function(calEvent, jsEvent, view) {
{#                alert('click');#}
                showChangeDialog(calEvent.start.format("YYYY-MM-DD HH:mm:ss"), calEvent.end.format("YYYY-MM-DD HH:mm:ss"), 28, calendar, calEvent.id);
            }
    });


    var calendar1 = $('#calendar2').fullCalendar({
                defaultView: 'agendaDay',
                lang: 'de',
                minTime: "10:00:00",
                //isRTL: true,
                allDaySlot: false,
                height: 650,
                buttonHtml: {
                prev: '<i class="ace-icon fa fa-chevron-left"></i>',
                        next: '<i class="ace-icon fa fa-chevron-right"></i>'
                },
                header: {
                left: 'title',
                        center: '',
                        right: 'today prev,next'
                },
                events: [
                {
                title: 'Peter Spieß, rwdata',
                        start: new Date(y, m, 1, 10, 0),
                        end: new Date(y, m, 1, 12, 0),
                        className: 'label-important'
                },
                {
                title: 'Torpedo Torfabrik Training',
                        start: new Date(y, m, 22, 12, 0),
                        end: new Date(y, m, 22, 13, 30),
                        className: 'label-success'
                },
                {
                title: 'Frank Baumann',
                        start: new Date(y, m, 22, 15, 0),
                        end: new Date(y, m, 22, 16, 0),
                        className: 'label-success'
                },
                ]
        });
                var calendar2 = $('#calendar3').fullCalendar({
        defaultView: 'agendaDay',
                lang: 'de',
                minTime: "10:00:00",
                //isRTL: true,
                allDaySlot: false,
                height: 650,
                buttonHtml: {
                prev: '<i class="ace-icon fa fa-chevron-left"></i>',
                        next: '<i class="ace-icon fa fa-chevron-right"></i>'
                },
                header: {
                left: 'title',
                        center: '',
                        right: 'today prev,next'
                },
                events: [
                {
                title: 'Firmencup 2014',
                        start: new Date(y, m, 22, 10, 0),
                        end: new Date(y, m, 22, 18, 0),
                        className: 'label-important'
                },
                ]
        });
                var calendar3 = $('#calendar4').fullCalendar({
        defaultView: 'agendaDay',
                lang: 'de',
                minTime: "10:00:00",
                //isRTL: true,
                allDaySlot: false,
                height: 650,
                buttonHtml: {
                prev: '<i class="ace-icon fa fa-chevron-left"></i>',
                        next: '<i class="ace-icon fa fa-chevron-right"></i>'
                },
                header: {
                left: 'title',
                        center: '',
                        right: 'today prev,next'
                },
                events: [
                {
                title: 'Firmencup 2014',
                        start: new Date(y, m, 22, 10, 0),
                        end: new Date(y, m, 22, 18, 0),
                        className: 'label-important'
                },
                ]
        });
        })
</script>
{% endblock %}
